<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My PWA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192x192.png">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
    <h1>Welcome to My PWA</h1>
    <p>This is a progressive web app demo.</p>

    <script>
        // Service Worker Logic
        const CACHE_NAME = 'pwa-cache-v1';
        const urlsToCache = [
            '/',
            '/index.html',
            '/manifest.json',
            '/icon-192x192.png',
            '/icon-512x512.png'
        ];

        // Install and Cache Static Assets
        self.addEventListener('install', event => {
            event.waitUntil(
                caches.open(CACHE_NAME).then(cache => {
                    console.log('Opened cache');
                    return cache.addAll(urlsToCache);
                })
            );
            self.skipWaiting(); // Activate worker immediately
        });

        // Activate and Remove Outdated Caches
        self.addEventListener('activate', event => {
            event.waitUntil(
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cache => {
                            if (cache !== CACHE_NAME) {
                                console.log('Deleting old cache:', cache);
                                return caches.delete(cache);
                            }
                        })
                    );
                })
            );
            self.clients.claim(); // Take control of the page immediately
        });

        // Fetch and Cache Resources Dynamically
        self.addEventListener('fetch', event => {
            event.respondWith(
                caches.match(event.request).then(response => {
                    return (
                        response ||
                        fetch(event.request).then(fetchResponse => {
                            return caches.open(CACHE_NAME).then(cache => {
                                cache.put(event.request, fetchResponse.clone());
                                return fetchResponse;
                            });
                        })
                    );
                }).catch(() => {
                    if (event.request.url.endsWith('.html')) {
                        return caches.match('/index.html');
                    }
                })
            );
        });

        // Network Reconnection Handling and Cache Update
        self.addEventListener('sync', event => {
            if (event.tag === 'update-cache') {
                event.waitUntil(
                    caches.open(CACHE_NAME).then(cache => {
                        return Promise.all(
                            urlsToCache.map(url => {
                                return fetch(url).then(response => {
                                    if (response.ok) {
                                        return cache.put(url, response);
                                    }
                                });
                            })
                        );
                    })
                );
            }
        });

        // Register the Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);

                    // Register background sync if supported
                    if ('SyncManager' in window) {
                        registration.sync.register('update-cache')
                            .then(() => {
                                console.log('Background sync registered for cache updates.');
                            })
                            .catch(err => {
                                console.error('Failed to register background sync:', err);
                            });
                    }
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }
    </script>
</body>
</html>
